name: Ini Tailwind Static Site

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: bootstrap-tailwind
  cancel-in-progress: false

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Create project structure
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p src public dist

          # HTML base
          cat > src/index.html <<'HTML'
          <!doctype html>
          <html lang="es-AR">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Tailwind Starter</title>
              <link href="./assets/app.css" rel="stylesheet" />
            </head>
            <body class="min-h-screen bg-slate-950 text-slate-50">
              <main class="mx-auto max-w-3xl p-8">
                <h1 class="text-4xl font-bold tracking-tight">Tailwind Starter</h1>
                <p class="mt-4 text-slate-300">
                  Repo inicializado por GitHub Actions. Build a <code class="rounded bg-slate-800 px-2 py-1">/dist</code>.
                </p>

                <div class="mt-8 rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
                  <p class="text-lg font-semibold">Listo para construir.</p>
                  <p class="mt-2 text-slate-300">Edita <code class="rounded bg-slate-800 px-2 py-1">src/index.html</code> y <code class="rounded bg-slate-800 px-2 py-1">src/styles.css</code>.</p>
                </div>
              </main>
            </body>
          </html>
          HTML

          # Tailwind entry
          cat > src/styles.css <<'CSS'
          @tailwind base;
          @tailwind components;
          @tailwind utilities;
          CSS

          # Basic public assets placeholder
          cat > public/.gitkeep <<'TXT'
          TXT

      - name: Initialize package.json (if missing)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f package.json ]; then
            npm init -y
          fi

      - name: Install Tailwind toolchain
        shell: bash
        run: |
          set -euo pipefail
          npm i -D tailwindcss postcss autoprefixer
          npx tailwindcss init -p || true

      - name: Write Tailwind + PostCSS configs
        shell: bash
        run: |
          set -euo pipefail

          cat > tailwind.config.js <<'JS'
          /** @type {import('tailwindcss').Config} */
          module.exports = {
            content: ["./src/**/*.{html,js,ts,jsx,tsx}"],
            theme: { extend: {} },
            plugins: [],
          };
          JS

          # postcss.config.js is created by `tailwindcss init -p`, but we enforce it
          cat > postcss.config.js <<'JS'
          module.exports = {
            plugins: {
              tailwindcss: {},
              autoprefixer: {},
            },
          };
          JS

      - name: Add build scripts
        shell: bash
        run: |
          set -euo pipefail

          node - <<'NODE'
          const fs = require('fs');

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.private = true;

          pkg.scripts ||= {};
          pkg.scripts.build = "rm -rf dist && mkdir -p dist/assets && cp -R public/. dist/ 2>/dev/null || true && cp -R src/index.html dist/index.html && npx tailwindcss -i ./src/styles.css -o ./dist/assets/app.css --minify";
          pkg.scripts.dev = "npx tailwindcss -i ./src/styles.css -o ./dist/assets/app.css --watch";
          pkg.scripts.clean = "rm -rf dist";

          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          NODE

      - name: Build to /dist (sanity check)
        shell: bash
        run: |
          set -euo pipefail
          npm run build
          test -f dist/index.html
          test -f dist/assets/app.css

      - name: Create .gitignore
        shell: bash
        run: |
          set -euo pipefail
          cat > .gitignore <<'TXT'
          node_modules
          dist
          .DS_Store
          npm-debug.log*
          yarn-debug.log*
          yarn-error.log*
          TXT

      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: ini tailwind project (dist build ready)"
          git push
