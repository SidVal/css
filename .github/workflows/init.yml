name: Init Tailwind Static Site (v4)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Scaffold project (src, public, dist, html, css, gitignore)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p src public dist/assets

          # Tailwind v4 entry
          if [ ! -f src/styles.css ]; then
            echo '@import "tailwindcss";' > src/styles.css
          fi

          # HTML base
          if [ ! -f src/index.html ]; then
            cat > src/index.html <<'HTML'
          <!doctype html>
          <html lang="es-AR">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Tailwind Starter</title>
              <link rel="stylesheet" href="./assets/app.css" />
            </head>
            <body class="bg-slate-900 text-white min-h-screen flex items-center justify-center">
              <h1 class="text-4xl font-bold">Tailwind v4 OK</h1>
            </body>
          </html>
          HTML
          fi

          # keep public
          [ -f public/.gitkeep ] || : > public/.gitkeep

          # .gitignore (siempre lo dejamos asÃ­)
          cat > .gitignore <<'TXT'
          node_modules
          dist
          .DS_Store
          npm-debug.log*
          yarn-debug.log*
          yarn-error.log*
          TXT

      - name: Create package.json if missing
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f package.json ]; then
            cat > package.json <<'JSON'
          {
            "name": "tailwind-project",
            "version": "1.0.0",
            "private": true,
            "type": "module",
            "scripts": {
              "dev": "npx @tailwindcss/cli -i ./src/styles.css -o ./dist/assets/app.css --watch",
              "build": "rm -rf dist && mkdir -p dist/assets && cp -R public/. dist/ 2>/dev/null || true && cp ./src/index.html ./dist/index.html && npx @tailwindcss/cli -i ./src/styles.css -o ./dist/assets/app.css --minify"
            }
          }
          JSON
          fi

      - name: Patch package.json scripts for dist build
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.private = true;
          pkg.type = pkg.type || 'module';

          pkg.devDependencies = pkg.devDependencies || {};
          pkg.devDependencies["@tailwindcss/cli"] = pkg.devDependencies["@tailwindcss/cli"] || "^4.2.1";

          pkg.scripts = pkg.scripts || {};
          pkg.scripts.dev = "npx @tailwindcss/cli -i ./src/styles.css -o ./dist/assets/app.css --watch";
          pkg.scripts.build = "rm -rf dist && mkdir -p dist/assets && cp ./src/index.html ./dist/index.html && npx @tailwindcss/cli -i ./src/styles.css -o ./dist/assets/app.css --minify";

          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          NODE

      - name: Ensure scripts in package.json
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.private = true;
          pkg.type = pkg.type || 'module';
          pkg.scripts = pkg.scripts || {};

          pkg.scripts.dev = "npx @tailwindcss/cli -i ./src/styles.css -o ./dist/assets/app.css --watch";
          pkg.scripts.build = "rm -rf dist && mkdir -p dist/assets && cp ./src/index.html ./dist/index.html && npx @tailwindcss/cli -i ./src/styles.css -o ./dist/assets/app.css --minify";

          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          NODE

      - name: Install deps (Tailwind v4 + CLI)
        shell: bash
        run: |
          set -euo pipefail
          npm install -D tailwindcss @tailwindcss/cli postcss autoprefixer

      - name: Remove node_modules from repo if tracked
        shell: bash
        run: |
          set -euo pipefail

          # Si hay cualquier archivo trackeado dentro de node_modules, lo sacamos del index
          if git ls-files | grep -q '^node_modules/'; then
            echo "Removiendo node_modules del repo..."
            git rm -r --cached node_modules || true
          fi

      - name: Build (sanity check)
        shell: bash
        run: |
          set -euo pipefail
          npm run build
          test -f dist/index.html
          test -f dist/assets/app.css

      - name: Commit and push (only if changes)
        shell: bash
        run: |
          set -euo pipefail

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: init tailwind v4 static site (dist ready)"
          git push
